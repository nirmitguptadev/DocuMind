name: DocuMind CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    # Use the standard free Linux runner
    runs-on: ubuntu-latest

    
    env:
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

    steps:
   
    - uses: actions/checkout@v4

    # 2. Set up Python 3.10
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip' # <--- IMPORTANT: This caches downloaded packages to save time!

    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    # 4. Check for syntax errors (Linting)
    - name: Lint with flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

    # 5. Run the Embedding Config Test
    # This confirms that sentence-transformers and langchain-huggingface are working
    # and that the model can be downloaded/cached successfully.
    - name: Test Local Embeddings (Smoke Test)
      run: python config.py

    # 6. (Optional) Run Groq Connection Test
  
    - name: Test Groq Connection
      if: env.GROQ_API_KEY != ''
      run: python llm_config.py
    
    # 7. (Optional - Future Phase) Build Docker Image
    # This checks if your Dockerfile is valid, even if you don't push the image anywhere.
    # Uncomment this step when you reach Phase 2 of your timeline.
    # - name: Verify Docker Build
    #   run: docker build . --file Dockerfile --tag documind:test
